name: ci
on: push

jobs:
  print-current-sha:
    runs-on: ubuntu-latest
    steps:
      - run: echo ${{ github.sha }}

  check-sha-result:
    runs-on: ubuntu-latest
    outputs:
      primary-result: ${{ steps.restore-cache.outputs.result }}
      primary-deploy_sha: ${{ steps.restore-cache.outputs.deploy_sha }}
      secondary-result: ${{ steps.restore-secondary-cache.outputs.result }}
      secondary-deploy_sha: ${{ steps.restore-secondary-cache.outputs.deploy_sha }}
    steps:
      - id: restore-cache
        uses: parallel-markets/cache-result-action@c14afc09e4d0a0777f4d0b928ac11deb6f958db4

      - id: restore-secondary-cache
        uses: parallel-markets/cache-result-action@c14afc09e4d0a0777f4d0b928ac11deb6f958db4
        with:
          key-prefix: secondary

  check:
    needs: check-sha-result
    runs-on: ubuntu-latest
    steps:
      - run: echo ${{ needs.check-sha-result.result }}
      - run: echo ${{ needs.check-sha-result.outputs.primary-result }}
      - run: echo ${{ needs.check-sha-result.outputs.secondary-result }}

  test:
    needs: check-sha-result
    runs-on: ubuntu-latest
    steps:
      - uses: parallel-markets/cache-result-action@c14afc09e4d0a0777f4d0b928ac11deb6f958db4
        with:
          result: success

  optional-test:
    needs: check-sha-result
    runs-on: ubuntu-latest
    steps:
      - uses: parallel-markets/cache-result-action@c14afc09e4d0a0777f4d0b928ac11deb6f958db4
        with:
          result: success
          key-prefix: secondary
